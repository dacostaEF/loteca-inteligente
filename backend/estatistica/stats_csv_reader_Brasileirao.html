<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Analisador Universal de Ligas - CSV Statistics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .upload-section {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dc2626;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .upload-section h2 {
            color: #dc2626;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            visibility: visible;
            opacity: 1;
        }

        .file-input-wrapper input[type=file] {
            display: none;
        }

        .file-input-label {
            background: #dc2626;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .file-input-label:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .clear-btn {
            background: #ef4444;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }

        .clear-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .sort-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
            margin-left: 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sort-btn.active {
            background: #dc2626;
            color: #fff;
        }

        .sort-btn.asc::after {
            content: " ‚Üë";
        }

        .sort-btn.desc::after {
            content: " ‚Üì";
        }

        .file-name {
            margin-top: 10px;
            color: #22c55e;
            font-weight: bold;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            display: block;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #2a2a2a;
            color: #888;
        }

        .tab-btn.active {
            background: #dc2626;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #333;
        }

        .tab-content {
            display: none;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .tab-content.active {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #0f0f0f;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #333;
            white-space: nowrap;
        }

        th:first-child,
        th:nth-child(2) {
            text-align: left;
        }

        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #222;
        }

        td:first-child,
        td:nth-child(2) {
            text-align: left;
            font-weight: 600;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #252525;
        }

        .pos-1 {
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
        }

        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-red { color: #ef4444; }
        .text-blue { color: #3b82f6; }
        .text-purple { color: #a855f7; }
        .text-orange { color: #f97316; }
        .text-pink { color: #ec4899; }

        .legend {
            background: #0f0f0f;
            padding: 20px;
            border-bottom: 2px solid #333;
        }

        .legend h3 {
            color: #eab308;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 12px;
        }

        .legend-item span {
            color: #eab308;
            font-weight: bold;
        }

        .header-gols { background: rgba(59, 130, 246, 0.3); }
        .header-over { background: rgba(34, 197, 94, 0.3); }
        .header-btts { background: rgba(234, 179, 8, 0.3); }
        .header-casa { background: rgba(168, 85, 247, 0.3); }
        .header-fora { background: rgba(249, 115, 22, 0.3); }
        .header-extras { background: rgba(236, 72, 153, 0.3); }
        .header-forma { background: rgba(220, 38, 38, 0.3); }

        .tips {
            background: #0f0f0f;
            padding: 20px;
            border-top: 2px solid #eab308;
        }

        .tips h4 {
            color: #eab308;
            margin-bottom: 10px;
        }

        .tips ul {
            list-style: none;
            font-size: 12px;
        }

        .tips li {
            padding: 5px 0;
        }

        .footer {
            text-align: center;
            color: #666;
            margin-top: 30px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section">
            <h2>üåç Analisador Universal de Ligas de Futebol</h2>
            <p style="color: #888; margin-bottom: 20px;">
                Carregue CSVs de QUALQUER liga: Brasileir√£o (A/B/C), Premier League, La Liga, Ligue 1, Champions League, etc. O sistema detecta automaticamente a estrutura e gera estat√≠sticas completas!
            </p>
            
            <!-- Controles em linha √∫nica -->
            <div class="controls-row">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
                    <label for="csvFile" class="file-input-label">
                        üìÅ Selecionar Arquivo CSV
                    </label>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="dirPicker" webkitdirectory directory multiple onchange="handleDirectoryUpload(event)">
                    <label for="dirPicker" class="file-input-label">
                        üåç Selecionar Pasta da Liga (Brasileir√£o, Premier League, La Liga, etc.)
                    </label>
                </div>

                <button class="clear-btn" onclick="clearAllData()">
                    üóëÔ∏è Limpar Tela/Dados
                </button>
            </div>
            
            <div id="fileName" class="file-name"></div>
            <div id="status" class="status"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="tabsSection" style="display: flex;">
            <button class="tab-btn active" onclick="showTab('tradicional')">
                üìã Tabela Tradicional
            </button>
            <button class="tab-btn" onclick="showTab('apostas')">
                üí∞ Estat√≠sticas para Apostas
            </button>
            <button class="tab-btn" onclick="exportarCSV()" style="background: #22c55e; color: white;">
                üìä Exportar CSV
            </button>
        </div>

        <!-- Tabela Tradicional -->
        <div id="tradicional" class="tab-content active">
            <div class="loading">Aguardando upload do arquivo CSV...</div>
        </div>

        <!-- Tabela de Apostas -->
        <div id="apostas" class="tab-content">
            <div class="loading">Aguardando upload do arquivo CSV...</div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>‚öΩ Sistema de Estat√≠sticas Autom√°ticas via CSV | C√°lculos em tempo real</p>
        </div>
    </div>

    <script>
        // Verificar se os elementos est√£o vis√≠veis
        document.addEventListener('DOMContentLoaded', function() {
            const uploadSection = document.querySelector('.upload-section');
            const fileInputs = document.querySelectorAll('.file-input-wrapper');
            const labels = document.querySelectorAll('.file-input-label');
            
            
            if (uploadSection) {
                uploadSection.style.display = 'block';
                uploadSection.style.visibility = 'visible';
                uploadSection.style.opacity = '1';
            }
            
            labels.forEach((label, index) => {
                label.style.display = 'inline-block';
                label.style.visibility = 'visible';
                label.style.opacity = '1';
            });
        });

        let dadosProcessados = [];
        let knownClubs = new Set();
        let pontosAcumuladosCSV = {}; // Armazena pontos acumulados dos CSVs por time
        let timesProcessados = []; // Armazena os times processados
        let currentSort = { column: 'pontos', direction: 'desc' }; // Ordena√ß√£o atual
        let ligaAtual = 'Gen√©rica'; // Liga atual detectada (Serie_A, Premier_League, La_Liga, etc)
        
        // üåç SISTEMA UNIVERSAL - SEM MAPEAMENTOS HARDCODED
        // Funciona com QUALQUER liga: Brasileir√£o, Premier League, La Liga, Ligue 1, Champions, etc.
        
        // Fun√ß√£o para detectar automaticamente a liga
        function detectarLiga(webkitRelativePath) {
            if (!webkitRelativePath) return 'Gen√©rica';
            
            const path = webkitRelativePath.toLowerCase();
            
            // Detecta pela pasta principal
            if (path.includes('serie_a') || path.includes('serie a')) return 'Brasileir√£o S√©rie A';
            if (path.includes('serie_b') || path.includes('serie b')) return 'Brasileir√£o S√©rie B';
            if (path.includes('serie_c') || path.includes('serie c')) return 'Brasileir√£o S√©rie C';
            if (path.includes('premier') || path.includes('premier_league')) return 'Premier League';
            if (path.includes('la_liga') || path.includes('laliga')) return 'La Liga';
            if (path.includes('ligue1') || path.includes('frances')) return 'Ligue 1';
            if (path.includes('champions')) return 'Champions League';
            
            return 'Gen√©rica';
        }

        /**
         * üåç NORMALIZA√á√ÉO UNIVERSAL DE NOMES DE TIMES
         * Funciona com qualquer liga sem mapeamentos hardcoded
         * @param {string} nome - O nome do time
         * @returns {string} O nome do time normalizado e capitalizado
         */
        function normalizarNomeTimeEntrada(nome) {
            if (!nome) return '';
            
            // Remove caracteres especiais e capitaliza
            const normalizado = String(nome)
                .trim()
                .replace(/[-_]/g, ' ')  // Troca - e _ por espa√ßo
                .replace(/\s+/g, ' ');   // Remove espa√ßos duplos
            
            return capitalizar(normalizado);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            
            // Extrair nome do time do nome do arquivo
            const nomeTime = extrairNomeTimeDoArquivo(file.name);
            
            if (!nomeTime) {
                showStatus('‚ö†Ô∏è N√£o foi poss√≠vel identificar o time. Renomeie o arquivo ou use a pasta.', 'error');
                return;
            }

            document.getElementById('fileName').textContent = `Processando: ${nomeTime}`;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    
                    // Se o nome do arquivo for gen√©rico (ex: jogos.csv), tenta descobrir o time dentro do CSV
                    let nomeTimeFinal = nomeTime;
                    if (nomeTime === 'Time Selecionado') {
                        nomeTimeFinal = inferirTimeDoCSV(results.data);
                    }
                    
                    // >>> NOVO PASSO CR√çTICO: Canoniza nome do time (corrige "Vol" -> "Volta Redonda")
                    const nomeTimeCanon = normalizarNomeTimeEntrada(nomeTimeFinal);
                    
                    document.getElementById('fileName').textContent = `Processando: ${nomeTimeCanon}`;
                    processarTime(nomeTimeCanon, results.data); // Chama com o nome canonizado
                },
                error: function(error) {
                    showStatus('Erro ao ler o arquivo: ' + error.message, 'error');
                }
            });
        }

        function extrairNomeTimeDoArquivo(fileName) {
            // Remove extens√£o
            const nameWithoutExt = fileName.replace(/\.csv$/i, '');
            
            // Se o nome for "jogos", tenta extrair do caminho do arquivo ou usa um nome padr√£o
            if (nameWithoutExt.toLowerCase() === 'jogos') {
                // Tenta extrair do caminho do arquivo se dispon√≠vel
                const filePath = fileName;
                
                // Para arquivo √∫nico, vamos usar um nome padr√£o ou pedir para o usu√°rio
                return 'Time Selecionado'; // Nome gen√©rico para arquivo √∫nico
            }
            
            // Tenta extrair do nome do arquivo (ex: "athletico-pr.csv" -> "Athletico Pr")
            const normalized = capitalizar(nameWithoutExt.replace(/[-_]/g, ' '));
            
            
            // >>> CORRE√á√ÉO: Canoniza antes de retornar (ex: "volta_redonda" -> "Volta Redonda")
            return normalizarNomeTimeEntrada(normalized);
        }

        // Descobre o nome do time principal olhando os dados do CSV
        function inferirTimeDoCSV(linhas) {
            const freq = new Map();
            const add = nome => {
                if (!nome) return;
                const key = ('' + nome).trim();
                if (!key) return;
                freq.set(key, (freq.get(key) || 0) + 1);
            };

            linhas.forEach(l => {
                add(l.Time_Casa);
                add(l.Time_Visitante);
            });

            let best = null, mx = -1;
            for (const [nome, qtd] of freq.entries()) {
                if (qtd > mx) { mx = qtd; best = nome; }
            }
            
            
            // >>> CORRE√á√ÉO: Canoniza antes de retornar (ex: "Vol" -> "Volta Redonda")
            return best ? normalizarNomeTimeEntrada(best) : 'Time Selecionado';
        }

        function processarDados(dados) {
            console.log('Dados recebidos:', dados);

            // Agrupar dados por time
            const timeStats = {};

            // Evitar contagem em dobro: mesm√≠ssimo jogo aparece em mais de um CSV
            const seen = new Set();

            // Ordena por data crescente para que "√öltimos 5" reflita os jogos mais recentes
            const normalizados = dados
                .map(normalizarLinha)
                .sort((a, b) => {
                    const da = parseDateStr(a.Data), db = parseDateStr(b.Data);
                    const ta = da ? da.getTime() : 0;
                    const tb = db ? db.getTime() : 0;
                    return ta - tb;
                });

            // Consolida duplicatas por (mandante, visitante, placar)
            const consolidados = consolidarDuplicatas(normalizados);

            consolidados.forEach(jogo => {
                const data = (jogo.Data || '').trim();
                const timeCasa = jogo.Time_Casa?.trim();
                const timeVisitante = jogo.Time_Visitante?.trim();

                if (!timeCasa || !timeVisitante) return; // linha inv√°lida
                // Filtra times fora da lista can√¥nica quando conhecida (evita 21¬∫ clube por ru√≠do)
                if (knownClubs.size > 0 && (!knownClubs.has(timeCasa) || !knownClubs.has(timeVisitante))) {
                    return;
                }

                // Captura pontos acumulados dos CSVs para verifica√ß√£o
                const pontosAcumuladosCasa = parseInt(jogo.Pontos_Acumulados || jogo.Pontos_Ganhos || 0);
                const pontosAcumuladosVisitante = parseInt(jogo.Pontos_Acumulados || jogo.Pontos_Ganhos || 0);
                
                // Armazena o √∫ltimo valor de pontos acumulados para cada time
                if (pontosAcumuladosCasa > 0) {
                    pontosAcumuladosCSV[timeCasa] = pontosAcumuladosCasa;
                }
                if (pontosAcumuladosVisitante > 0) {
                    pontosAcumuladosCSV[timeVisitante] = pontosAcumuladosVisitante;
                }

                const golsCasa = parseInt(jogo.Gols_Casa) || 0;
                const golsVisitante = parseInt(jogo.Gols_Visitante) || 0;
                const totalGols = golsCasa + golsVisitante;

                // Chave √∫nica do jogo com data e nomes normalizados
                const iso = toISODate(parseDateStr(data)) || 'unk';
                const key = `${iso}|${norm(timeCasa)}|${norm(timeVisitante)}|${golsCasa}-${golsVisitante}`;
                if (seen.has(key)) return; // j√° processado a partir de outro CSV
                seen.add(key);
                
                // Inicializar times
                if (!timeStats[timeCasa]) timeStats[timeCasa] = initTimeStats(timeCasa);
                if (!timeStats[timeVisitante]) timeStats[timeVisitante] = initTimeStats(timeVisitante);

                // Processar jogo para time da casa
                processarJogo(timeStats[timeCasa], golsCasa, golsVisitante, totalGols, true, jogo);
                
                // Processar jogo para time visitante
                processarJogo(timeStats[timeVisitante], golsVisitante, golsCasa, totalGols, false, jogo);
            });

            // Converter para array e ordenar: Pontos ‚Üí Vit√≥rias ‚Üí Saldo ‚Üí Gols Pr√≥ ‚Üí Nome
            dadosProcessados = Object.values(timeStats)
                .map(team => { calcularPercentuais(team); return team; })
                .sort((a, b) =>
                    (b.pontos - a.pontos) ||
                    (b.vitorias - a.vitorias) ||
                    (b.saldoGols - a.saldoGols) ||
                    (b.golsPro - a.golsPro) ||
                    a.time.localeCompare(b.time)
                )
                .map((t, i) => ({ ...t, pos: i + 1 }));

            // Mant√©m apenas clubes da lista conhecida e garante no m√°ximo 20
            if (knownClubs.size > 0) {
                dadosProcessados = dadosProcessados.filter(t => knownClubs.has(t.time));
                dadosProcessados = dadosProcessados.map((t, i) => ({ ...t, pos: i + 1 }));
            }
            if (dadosProcessados.length > 20) {
                dadosProcessados = dadosProcessados.slice(0, 20).map((t, i) => ({ ...t, pos: i + 1 }));
            }

            // Verifica√ß√£o de pontos removida - causava ru√≠do por associar pontos do clube A ao advers√°rio
            
            renderizarTabelas();
            document.getElementById('tabsSection').style.display = 'flex';
            showStatus('‚úÖ Dados processados com sucesso!', 'success');
        }

        // üåç NORMALIZA√á√ÉO UNIVERSAL - Funciona com qualquer formato de CSV
        function normalizarLinha(row) {
            const Data = row.Data ?? row["data"] ?? row["Data_Jogo"] ?? row["Date"] ?? '';
            
            // Aplica sanitiza√ß√£o ANTES da normaliza√ß√£o
            let Time_Casa = sanitizeCorruptText(row.Time_Casa ?? row["Time Casa"] ?? row["Mandante"] ?? row["home"] ?? row["time_casa"] ?? '');
            let Time_Visitante = sanitizeCorruptText(row.Time_Visitante ?? row.Time_Fora ?? row["Time Fora"] ?? row["Visitante"] ?? row["away"] ?? row["time_fora"] ?? '');
            
            // Normaliza nomes de times contra lista conhecida de pastas
            Time_Casa = normalizarTime(Time_Casa);
            Time_Visitante = normalizarTime(Time_Visitante);
            
            const Gols_Casa = row.Gols_Casa ?? row["Gols Casa"] ?? row["Placar_Casa"] ?? row["home_goals"] ?? row["gols_casa"] ?? row["Casa"] ?? row["Gols mandante"];
            const Gols_Visitante = row.Gols_Visitante ?? row.Gols_Fora ?? row["Gols Fora"] ?? row["Placar_Visitante"] ?? row["away_goals"] ?? row["gols_fora"] ?? row["Fora"] ?? row["Gols visitante"];
            
            return { Data, Time_Casa, Time_Visitante, Gols_Casa, Gols_Visitante };
        }

        // üåç NORMALIZA√á√ÉO UNIVERSAL DE TIMES - Funciona com QUALQUER liga
        function normalizarTime(nome) {
            if (!nome) return '';
            const n = removerAcentos(String(nome).trim().toLowerCase());
            
            // Match com clubes conhecidos (da pasta selecionada)
            if (knownClubs.size > 0) {
                // Tentativa 1: match exato
                for (const club of knownClubs) {
                    const c = removerAcentos(club.toLowerCase());
                    if (n === c) return club;
                }
                
                // Tentativa 2: cont√©m ou √© contido
                for (const club of knownClubs) {
                    const c = removerAcentos(club.toLowerCase());
                    if (c.includes(n) || n.includes(c)) return club;
                }
                
                // Tentativa 3: come√ßa com as mesmas 3 letras
                const prefix = n.slice(0, 3);
                for (const club of knownClubs) {
                    const c = removerAcentos(club.toLowerCase());
                    if (c.startsWith(prefix) && prefix.length >= 3) return club;
                }
            }
            
            // Sem match, capitaliza entrada
            return capitalizar(nome);
        }

        function removerAcentos(s) {
            return s.normalize('NFD').replace(/\p{Diacritic}+/gu, '');
        }

        function capitalizar(s) {
            return String(s).toLowerCase().replace(/\b\w/g, ch => ch.toUpperCase());
        }

        // Utilit√°rios de data e normaliza√ß√£o - Parser tolerante para datas "quebradas"
        function parseDateStr(s){
            if(!s) return null;
            const m = String(s).trim();
            const m1 = m.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,5})$/); // dd/mm/yy..yyyyy
            if (m1){
                const d = +m1[1], mm = +m1[2]-1;
                let y = +m1[3];
                
                // Corrige anos estranhos
                if (y > 2100) y = +String(y).slice(-4); // 20125 -> 0125 -> 125? ent√£o garanta 4 d√≠gitos
                if (y < 100) y = 2000 + y;              // 25 -> 2025
                // corrige casos esquisitos tipo 0125
                if (y < 2000 || y > 2100) y = 2025;     // fallback seguro
                
                return new Date(y, mm, d);
            }
            const t = Date.parse(m);
            return Number.isNaN(t) ? null : new Date(t);
        }
        function toISODate(d){
            return d ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : '';
        }
        function norm(s){
            return removerAcentos(String(s||'').toLowerCase().trim());
        }

        // Sanitiza√ß√£o extra para textos corrompidos (ex.: SÔøΩo -> Sao)
        function sanitizeCorruptText(s){
            if (!s) return s;
            return String(s)
                .replace(/SÔøΩo/gi, 'Sao')
                .replace(/AtlÔøΩtico/gi, 'Atletico')
                .replace(/ÔøΩ/g, '');
        }

        // Consolida duplicatas por (mandante, visitante, placar)
        function consolidarDuplicatas(lista) {
            // Descobre ano dominante da temporada
            const anos = lista.map(j => parseDateStr(j.Data)?.getFullYear()).filter(Boolean);
            const anoFreq = anos.reduce((acc,a)=> (acc[a]=(acc[a]||0)+1, acc), {});
            const anoTemporada = Object.keys(anoFreq).sort((a,b)=> anoFreq[b]-anoFreq[a])[0] || '2025';

            const byKey = new Map(); // key: mand|visit|gc-gv -> jogo escolhido
            for (const jogo of lista) {
                const d = parseDateStr(jogo.Data);
                const y = d?.getFullYear();
                const gc = parseInt(jogo.Gols_Casa)||0, gv = parseInt(jogo.Gols_Visitante)||0;
                const k = `${norm(jogo.Time_Casa)}|${norm(jogo.Time_Visitante)}|${gc}-${gv}`;

                const curr = byKey.get(k);
                if (!curr) { byKey.set(k, jogo); continue; }

                const dCurr = parseDateStr(curr.Data);
                const yCurr = dCurr?.getFullYear();

                // Prefer√™ncia: (1) ano == temporada, (2) data mais recente
                const prefereNovo =
                    (y == anoTemporada && yCurr != anoTemporada) ||
                    (y == anoTemporada && yCurr == anoTemporada && d && dCurr && d > dCurr) ||
                    (!yCurr && y); // fallback

                if (prefereNovo) byKey.set(k, jogo);
            }
            return Array.from(byKey.values());
        }

        // Verifica pontos acumulados dos CSVs vs pontos calculados
        function verificarPontosAcumulados() {
            console.log('=== VERIFICA√á√ÉO DE PONTOS ACUMULADOS ===');
            console.log('Pontos dos CSVs:', pontosAcumuladosCSV);
            
            const discrep√¢ncias = [];
            
            dadosProcessados.forEach(team => {
                const pontosCalculados = team.pontos;
                const pontosCSV = pontosAcumuladosCSV[team.time];
                
                if (pontosCSV !== undefined) {
                    const diferen√ßa = Math.abs(pontosCalculados - pontosCSV);
                    if (diferen√ßa > 0) {
                        discrep√¢ncias.push({
                            time: team.time,
                            pontosCalculados,
                            pontosCSV,
                            diferen√ßa
                        });
                    }
                    console.log(`${team.time}: Calculado=${pontosCalculados}, CSV=${pontosCSV}, Diferen√ßa=${diferen√ßa}`);
                } else {
                    console.log(`${team.time}: Calculado=${pontosCalculados}, CSV=N/A`);
                }
            });
            
            if (discrep√¢ncias.length > 0) {
                console.warn('‚ö†Ô∏è DISCREP√ÇNCIAS ENCONTRADAS:');
                discrep√¢ncias.forEach(d => {
                    console.warn(`${d.time}: Calculado=${d.pontosCalculados}, CSV=${d.pontosCSV}, Diferen√ßa=${d.diferen√ßa}`);
                });
                
                // Exibe alerta visual para o usu√°rio
                const mensagem = `‚ö†Ô∏è ATEN√á√ÉO: Encontradas ${discrep√¢ncias.length} discrep√¢ncias nos pontos:\n\n` +
                    discrep√¢ncias.map(d => 
                        `${d.time}: Calculado=${d.pontosCalculados}, CSV=${d.pontosCSV} (diferen√ßa: ${d.diferen√ßa})`
                    ).join('\n');
                
                alert(mensagem);
            } else {
                console.log('‚úÖ Todos os pontos coincidem com os CSVs!');
            }
        }

        function initTimeStats(nome) {
            return {
                time: nome,
                jogos: 0,
                vitorias: 0,
                empates: 0,
                derrotas: 0,
                pontos: 0,
                golsPro: 0,
                golsContra: 0,
                // Casa
                jogosCasa: 0,
                vitoriasCasa: 0,
                empatesCasa: 0,
                derrotasCasa: 0,
                golsProCasa: 0,
                golsContraCasa: 0,
                // Fora
                jogosFora: 0,
                vitoriasFora: 0,
                empatesFora: 0,
                derrotasFora: 0,
                golsProFora: 0,
                golsContraFora: 0,
                // Estat√≠sticas especiais
                over15: 0,
                over25: 0,
                over35: 0,
                bttsYes: 0,
                cleanSheets: 0,
                primeiroGol: 0,
                viradas: 0,
                ultimos5: [],
                pontosUlt5: 0
            };
        }

        function processarJogo(team, golsPro, golsContra, totalGols, isCasa, jogo) {
            team.jogos++;
            team.golsPro += golsPro;
            team.golsContra += golsContra;

            // Resultado
            let resultado = '';
            let pontosGanhos = 0;
            if (golsPro > golsContra) {
                team.vitorias++;
                resultado = 'V';
                pontosGanhos = 3;
            } else if (golsPro === golsContra) {
                team.empates++;
                resultado = 'E';
                pontosGanhos = 1;
            } else {
                team.derrotas++;
                resultado = 'D';
                pontosGanhos = 0;
            }
            team.pontos += pontosGanhos;

            // Casa/Fora
            if (isCasa) {
                team.jogosCasa++;
                team.golsProCasa += golsPro;
                team.golsContraCasa += golsContra;
                if (golsPro > golsContra) team.vitoriasCasa++;
                else if (golsPro === golsContra) team.empatesCasa++;
                else team.derrotasCasa++;
            } else {
                team.jogosFora++;
                team.golsProFora += golsPro;
                team.golsContraFora += golsContra;
                if (golsPro > golsContra) team.vitoriasFora++;
                else if (golsPro === golsContra) team.empatesFora++;
                else team.derrotasFora++;
            }

            // Over/Under
            if (totalGols >= 2) team.over15++;
            if (totalGols >= 3) team.over25++;
            if (totalGols >= 4) team.over35++;

            // BTTS
            if (golsPro > 0 && golsContra > 0) team.bttsYes++;

            // Clean Sheet
            if (golsContra === 0) team.cleanSheets++;

            // Primeiro a marcar - REMOVIDO: c√°lculo incorreto sem dados de minuto
            // if (golsPro > 0 && (golsContra === 0 || golsPro > golsContra)) team.primeiroGol++;

            // √öltimos 5 jogos (mais antigo ‚Üí mais recente, da esquerda para direita)
            team.ultimos5.push(resultado);
            if (team.ultimos5.length > 5) team.ultimos5.shift();
        }

        function calcularPercentuais(team) {
            team.aproveitamento = Math.round((team.pontos / (team.jogos * 3)) * 100);
            team.mediaGolsPro = (team.golsPro / team.jogos).toFixed(2);
            team.mediaGolsContra = (team.golsContra / team.jogos).toFixed(2);
            team.saldoGols = team.golsPro - team.golsContra;

            // Percentuais
            team.over15Perc = Math.round((team.over15 / team.jogos) * 100);
            team.over25Perc = Math.round((team.over25 / team.jogos) * 100);
            team.over35Perc = Math.round((team.over35 / team.jogos) * 100);
            team.under25Perc = 100 - team.over25Perc;
            
            team.bttsYesPerc = Math.round((team.bttsYes / team.jogos) * 100);
            team.bttsNoPerc = 100 - team.bttsYesPerc;
            
            team.cleanSheetsPerc = Math.round((team.cleanSheets / team.jogos) * 100);
            team.primeiroGolPerc = null; // N/D - sem dados de minuto
            team.viradasPerc = null;     // N/D - sem dados de minuto

            // Aproveitamento casa/fora
            team.aprovCasa = team.jogosCasa > 0 ? Math.round((((team.vitoriasCasa * 3) + team.empatesCasa) / (team.jogosCasa * 3)) * 100) : 0;
            team.aprovFora = team.jogosFora > 0 ? Math.round((((team.vitoriasFora * 3) + team.empatesFora) / (team.jogosFora * 3)) * 100) : 0;

            // √öltimos 5
            team.ultimos5Str = team.ultimos5.join('-');
            team.pontosUlt5 = team.ultimos5.reduce((sum, r) => {
                if (r === 'V') return sum + 3;
                if (r === 'E') return sum + 1;
                return sum;
            }, 0);

            // Gols 2¬∫ tempo - N/D sem dados de minuto
            team.gols2TempoPerc = null; // N/D - sem dados de minuto
        }

        function renderizarTabelas() {
            dadosProcessados = timesProcessados
                .map(t => { calcularPercentuais(t); return t; })
                .sort((a, b) =>
                    (b.pontos - a.pontos) ||
                    (b.vitorias - a.vitorias) ||
                    (b.saldoGols - a.saldoGols) ||
                    (b.golsPro - a.golsPro) ||
                    a.time.localeCompare(b.time)
                )
                .map((t, i) => ({ ...t, pos: i + 1 }));

            // Mostra as abas
            document.getElementById('tabsSection').style.display = 'flex';
            
            renderTradicional();
            renderApostas();
        }

        function renderTradicional() {
            const container = document.getElementById('tradicional');
            
            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th># <button class="sort-btn ${currentSort.column === 'pos' ? currentSort.direction : ''}" onclick="sortData('pos')">‚Üï</button></th>
                                <th>CLASSIFICA√á√ÉO <button class="sort-btn ${currentSort.column === 'time' ? currentSort.direction : ''}" onclick="sortData('time')">‚Üï</button></th>
                                <th>P <button class="sort-btn ${currentSort.column === 'pontos' ? currentSort.direction : ''}" onclick="sortData('pontos')">‚Üï</button></th>
                                <th>J <button class="sort-btn ${currentSort.column === 'jogos' ? currentSort.direction : ''}" onclick="sortData('jogos')">‚Üï</button></th>
                                <th>V <button class="sort-btn ${currentSort.column === 'vitorias' ? currentSort.direction : ''}" onclick="sortData('vitorias')">‚Üï</button></th>
                                <th>E <button class="sort-btn ${currentSort.column === 'empates' ? currentSort.direction : ''}" onclick="sortData('empates')">‚Üï</button></th>
                                <th>D <button class="sort-btn ${currentSort.column === 'derrotas' ? currentSort.direction : ''}" onclick="sortData('derrotas')">‚Üï</button></th>
                                <th>GP <button class="sort-btn ${currentSort.column === 'golsPro' ? currentSort.direction : ''}" onclick="sortData('golsPro')">‚Üï</button></th>
                                <th>GC <button class="sort-btn ${currentSort.column === 'golsContra' ? currentSort.direction : ''}" onclick="sortData('golsContra')">‚Üï</button></th>
                                <th>SG <button class="sort-btn ${currentSort.column === 'saldoGols' ? currentSort.direction : ''}" onclick="sortData('saldoGols')">‚Üï</button></th>
                                <th>% <button class="sort-btn ${currentSort.column === 'aproveitamento' ? currentSort.direction : ''}" onclick="sortData('aproveitamento')">‚Üï</button></th>
                                <th>CSV</th>
                                <th>√öLTIMOS</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dadosProcessados.forEach(team => {
                const ultimos = team.ultimos5.map(r => {
                    if (r === 'V') return 'üü¢';
                    if (r === 'E') return 'üü°';
                    return 'üî¥';
                }).join('');

                html += `
                    <tr class="${team.pos === 1 ? 'pos-1' : ''}">
                        <td><strong>${team.pos}</strong></td>
                        <td><strong>${team.time}</strong></td>
                        <td><strong>${team.pontos}</strong></td>
                        <td>${team.jogos}</td>
                        <td class="text-green">${team.vitorias}</td>
                        <td class="text-yellow">${team.empates}</td>
                        <td class="text-red">${team.derrotas}</td>
                        <td>${team.golsPro}</td>
                        <td>${team.golsContra}</td>
                        <td class="text-green"><strong>${team.saldoGols > 0 ? '+' : ''}${team.saldoGols}</strong></td>
                        <td><strong>${team.aproveitamento}</strong></td>
                        <td class="text-blue"><strong>${pontosAcumuladosCSV[team.time] || 'N/A'}</strong></td>
                        <td style="font-size: 11px;">${ultimos}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderApostas() {
            
            if (dadosProcessados.length === 0) {
                return;
            }
            
            const container = document.getElementById('apostas');
            
            let html = `
                <div class="legend">
                    <h3>üí° LEGENDA DAS COLUNAS</h3>
                    <div class="legend-grid">
                        <div class="legend-item"><span>MG/MS:</span> M√©dia Gols Pro/Contra</div>
                        <div class="legend-item"><span>OV:</span> Over (% jogos)</div>
                        <div class="legend-item"><span>UN:</span> Under (% jogos)</div>
                        <div class="legend-item"><span>BTTS:</span> Ambas Marcam (%)</div>
                        <div class="legend-item"><span>Casa/Fora:</span> J-V-E-D-GP-GC-AP%</div>
                        <div class="legend-item"><span>CS:</span> Clean Sheets (%) - Jogos sem tomar gol</div>
                        <div class="legend-item"><span>P1G:</span> Primeiro a Marcar (%) - Quantas vezes marcou primeiro</div>
                        <div class="legend-item"><span>VIR:</span> Viradas (%) - Quantas vezes virou jogo perdendo</div>
                        <div class="legend-item"><span>G2T:</span> Gols 2¬∫ Tempo (%) - % de gols no segundo tempo</div>
                        <div class="legend-item"><span>√öLT5:</span> √öltimos 5 Jogos</div>
                        <div class="legend-item"><span>PT5:</span> Pontos nos √ölt. 5</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2"># <button class="sort-btn ${currentSort.column === 'pos' ? currentSort.direction : ''}" onclick="sortData('pos')">‚Üï</button></th>
                                <th rowspan="2">TIME <button class="sort-btn ${currentSort.column === 'time' ? currentSort.direction : ''}" onclick="sortData('time')">‚Üï</button></th>
                                <th rowspan="2">J <button class="sort-btn ${currentSort.column === 'jogos' ? currentSort.direction : ''}" onclick="sortData('jogos')">‚Üï</button></th>
                                <th colspan="4" class="header-gols">GOLS</th>
                                <th colspan="4" class="header-over">OVER/UNDER (%)</th>
                                <th colspan="2" class="header-btts">BTTS (%)</th>
                                <th colspan="7" class="header-casa">MANDANTE (CASA)</th>
                                <th colspan="7" class="header-fora">VISITANTE (FORA)</th>
                                <th colspan="4" class="header-extras">EXTRAS (%)</th>
                                <th colspan="2" class="header-forma">FORMA</th>
                            </tr>
                            <tr style="font-size: 11px;">
                                <th class="header-gols">GP <button class="sort-btn ${currentSort.column === 'golsPro' ? currentSort.direction : ''}" onclick="sortData('golsPro')">‚Üï</button></th>
                                <th class="header-gols">GC <button class="sort-btn ${currentSort.column === 'golsContra' ? currentSort.direction : ''}" onclick="sortData('golsContra')">‚Üï</button></th>
                                <th class="header-gols">MG</th>
                                <th class="header-gols">MS</th>
                                <th class="header-over">1.5+</th>
                                <th class="header-over">2.5+</th>
                                <th class="header-over">3.5+</th>
                                <th class="header-over">U2.5</th>
                                <th class="header-btts">Sim</th>
                                <th class="header-btts">N√£o</th>
                                <th class="header-casa">J</th>
                                <th class="header-casa">V</th>
                                <th class="header-casa">E</th>
                                <th class="header-casa">D</th>
                                <th class="header-casa">GP</th>
                                <th class="header-casa">GC</th>
                                <th class="header-casa">AP%</th>
                                <th class="header-fora">J</th>
                                <th class="header-fora">V</th>
                                <th class="header-fora">E</th>
                                <th class="header-fora">D</th>
                                <th class="header-fora">GP</th>
                                <th class="header-fora">GC</th>
                                <th class="header-fora">AP%</th>
                                <th class="header-extras">CS</th>
                                <th class="header-extras">P1G</th>
                                <th class="header-extras">VIR</th>
                                <th class="header-extras">G2T</th>
                                <th class="header-forma">√öLT5</th>
                                <th class="header-forma">PT5</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dadosProcessados.forEach((team, index) => {
                
                html += `
                    <tr class="${team.pos === 1 ? 'pos-1' : ''}">
                        <td><strong>${team.pos}</strong></td>
                        <td><strong>${team.time}</strong></td>
                        <td>${team.jogos}</td>
                        
                        <td>${team.golsPro}</td>
                        <td>${team.golsContra}</td>
                        <td class="text-green"><strong>${team.mediaGolsPro}</strong></td>
                        <td class="text-red"><strong>${team.mediaGolsContra}</strong></td>
                        
                        <td class="text-green"><strong>${team.over15Perc}%</strong></td>
                        <td class="text-green"><strong>${team.over25Perc}%</strong></td>
                        <td class="text-yellow"><strong>${team.over35Perc}%</strong></td>
                        <td class="text-red"><strong>${team.under25Perc}%</strong></td>
                        
                        <td class="text-yellow"><strong>${team.bttsYesPerc}%</strong></td>
                        <td class="text-green"><strong>${team.bttsNoPerc}%</strong></td>
                        
                        <td>${team.jogosCasa}</td>
                        <td class="text-green">${team.vitoriasCasa}</td>
                        <td class="text-yellow">${team.empatesCasa}</td>
                        <td class="text-red">${team.derrotasCasa}</td>
                        <td>${team.golsProCasa}</td>
                        <td>${team.golsContraCasa}</td>
                        <td class="text-purple"><strong>${team.aprovCasa}%</strong></td>
                        
                        <td>${team.jogosFora}</td>
                        <td class="text-green">${team.vitoriasFora}</td>
                        <td class="text-yellow">${team.empatesFora}</td>
                        <td class="text-red">${team.derrotasFora}</td>
                        <td>${team.golsProFora}</td>
                        <td>${team.golsContraFora}</td>
                        <td class="text-orange"><strong>${team.aprovFora}%</strong></td>
                        
                        <td class="text-green"><strong>${team.cleanSheetsPerc}%</strong></td>
                        <td class="text-blue"><strong>${team.primeiroGolPerc ?? 'N/D'}</strong></td>
                        <td class="text-yellow"><strong>${team.viradasPerc ?? 'N/D'}</strong></td>
                        <td class="text-pink"><strong>${team.gols2TempoPerc ?? 'N/D'}</strong></td>
                        
                        <td style="font-family: monospace; font-size: 10px;">${team.ultimos5Str}</td>
                        <td class="text-green"><strong>${team.pontosUlt5}</strong></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="tips">
                    <h4>üí° DICAS PARA APOSTAS</h4>
                    <ul>
                        <li>‚úÖ <strong>Over 2.5 acima de 60%:</strong> Time ofensivo, bom para apostas de gols</li>
                        <li>‚úÖ <strong>Clean Sheets acima de 50%:</strong> Defesa s√≥lida - aposte "Ambas Marcam = N√£o"</li>
                        <li>‚úÖ <strong>BTTS N√£o alto:</strong> Time que n√£o toma muitos gols</li>
                        <li>‚úÖ <strong>Aprv. Casa vs Fora:</strong> Compare onde o time joga melhor</li>
                        <li>‚úÖ <strong>Forma (√öLT5):</strong> Momento atual do time</li>
                    </ul>
                    
                    <h4>üéØ INDICADORES EXTRAS PARA APOSTAS</h4>
                    <ul>
                        <li>üõ°Ô∏è <strong>CS (Clean Sheets):</strong> Alto = aposte "Ambas Marcam = N√£o"</li>
                        <li>üéØ <strong>P1G (Primeiro a Marcar):</strong> Alto = aposte "Primeiro a Marcar"</li>
                        <li>üîÑ <strong>VIR (Viradas):</strong> Alto = aposte "Handicap +1" ou "Ambas Marcam = Sim"</li>
                        <li>‚è∞ <strong>G2T (Gols 2¬∫ Tempo):</strong> Alto = aposte "Over 0.5 2¬∫ tempo"</li>
                        <li>‚ö†Ô∏è <strong>N/D:</strong> Indicadores sem dados suficientes (precisam minuto dos gols)</li>
                    </ul>
                </div>
            `;

            container.innerHTML = html;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // üåç LEITURA UNIVERSAL - Funciona com QUALQUER liga (Brasileir√£o, Premier League, La Liga, etc.)
        function handleDirectoryUpload(event) {
            const files = Array.from(event.target.files || []);
            if (files.length === 0) return;

            const csvFiles = files.filter(f => f.name.toLowerCase() === 'jogos.csv' || f.name.toLowerCase().endsWith('.csv'));
            
            // Detectar liga automaticamente
            ligaAtual = detectarLiga(files[0]?.webkitRelativePath || '');
            console.log(`üåç Liga detectada: ${ligaAtual}`);
            
            console.log(`üåç Total de arquivos: ${files.length} | CSVs encontrados: ${csvFiles.length}`);
            
            if (csvFiles.length === 0) {
                showStatus('‚ùå Nenhum arquivo CSV encontrado na pasta selecionada.', 'error');
                return;
            }

            // üåç DERIVA NOMES DOS CLUBES - UNIVERSAL para qualquer estrutura de pastas
            knownClubs = new Set();
            csvFiles.forEach(f => {
                const rel = f.webkitRelativePath || '';
                const parts = rel.split(/[\\\/]/g).filter(p => p && p !== '.');
                
                const ultimoSegmento = parts[parts.length - 1] || '';
                const penultimoSegmento = parts[parts.length - 2] || '';
                
                let clubSeg = '';
                
                // CASO 1: CSV direto na pasta (ex: Premier_ligue/arsenal.csv)
                if (ultimoSegmento.toLowerCase().endsWith('.csv') && 
                    ultimoSegmento.toLowerCase() !== 'jogos.csv') {
                    clubSeg = ultimoSegmento.replace(/\.csv$/i, '');
                }
                // CASO 2: CSV em subpasta (ex: Serie_A/flamengo/jogos.csv)
                else {
                    clubSeg = penultimoSegmento;
                }
                
                if (clubSeg) {
                    const nomeClube = capitalizar(clubSeg.replace(/[-_]/g, ' '));
                    knownClubs.add(nomeClube);
                    console.log(`‚úÖ Time detectado: ${nomeClube}`);
                }
            });

            document.getElementById('fileName').textContent = `üåç ${ligaAtual} | ${csvFiles.length} times detectados`;
            showStatus(`‚úÖ Liga: ${ligaAtual} | Carregando ${csvFiles.length} times...`, 'success');

            // Parsear todos em paralelo
            const parsePromises = csvFiles.map(file => new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    worker: true,
                    complete: res => resolve(res.data || []),
                    error: err => reject(err)
                });
            }));

            // Processar arquivo por arquivo (um time por vez)
            processarArquivosSequencialmente(csvFiles, 0);
        }

        function processarArquivosSequencialmente(files, index) {
            console.log(`üîç DEBUG: processarArquivosSequencialmente chamada - index: ${index}, files.length: ${files.length}`);
            
            if (index >= files.length) {
                console.log(`‚úÖ PROCESSAMENTO CONCLU√çDO! Total de times processados: ${timesProcessados.length}`);
                console.log(`üîç DEBUG: Lista final de times:`, timesProcessados.map(t => t.time));
                showStatus(`‚úÖ Conclu√≠do! ${timesProcessados.length} times processados.`, 'success');
                return;
            }

            const file = files[index];
            console.log(`üîç DEBUG: Processando arquivo ${index + 1}/${files.length}: ${file.name}`);
            console.log(`üîç DEBUG: webkitRelativePath: ${file.webkitRelativePath}`);
            
            // DEBUG ESPEC√çFICO PARA GR√äMIO NOVO HORIZONTINO
            if (file.webkitRelativePath && file.webkitRelativePath.toLowerCase().includes('novohorizontino')) {
                console.log(`üîç DEBUG GR√äMIO NOVO HORIZONTINO - Arquivo encontrado:`);
                console.log(`  - fileName: "${file.name}"`);
                console.log(`  - webkitRelativePath: "${file.webkitRelativePath}"`);
            }
            
            const nomeTime = extrairNomeTime(file.name, file.webkitRelativePath || '');
            console.log(`üîç DEBUG: nomeTime extra√≠do: ${nomeTime}`);
            
            if (!nomeTime) {
                console.log(`‚ö†Ô∏è N√£o foi poss√≠vel identificar o time do arquivo: ${file.name}`);
                processarArquivosSequencialmente(files, index + 1);
                return;
            }

            document.getElementById('fileName').textContent = `Processando: ${nomeTime} (${index + 1}/${files.length})`;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processarTime(nomeTime, results.data);
                    console.log(`üîç DEBUG: Time ${nomeTime} processado. Pr√≥ximo arquivo...`);
                    processarArquivosSequencialmente(files, index + 1);
                },
                error: function(error) {
                    console.error('Erro ao ler arquivo:', error);
                    processarArquivosSequencialmente(files, index + 1);
                }
            });
        }

        // üåç EXTRA√á√ÉO UNIVERSAL DE NOMES - Funciona com QUALQUER estrutura de pastas
        function extrairNomeTime(fileName, webkitRelativePath) {
            const rel = webkitRelativePath || '';
            const parts = rel.split(/[\\\/]/g).filter(p => p && p !== '.');
            
            const ultimoSegmento = parts[parts.length - 1] || '';
            const penultimoSegmento = parts[parts.length - 2] || '';
            
            let clubSeg = '';
            
            // CASO 1: CSV direto na pasta (ex: Premier_ligue/arsenal.csv)
            // Detecta se o √∫ltimo segmento √© um arquivo CSV com nome pr√≥prio (n√£o "jogos.csv")
            if (ultimoSegmento.toLowerCase().endsWith('.csv') && 
                ultimoSegmento.toLowerCase() !== 'jogos.csv') {
                clubSeg = ultimoSegmento.replace(/\.csv$/i, '');
                console.log(`‚úÖ Estrutura DIRETA detectada: ${clubSeg}`);
            }
            // CASO 2: CSV em subpasta (ex: Serie_A/flamengo/jogos.csv)
            else {
                clubSeg = penultimoSegmento;
                console.log(`‚úÖ Estrutura SUBPASTA detectada: ${clubSeg}`);
            }
            
            if (!clubSeg) {
                console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel extrair nome do time de: ${rel}`);
                return null;
            }
            
            const result = capitalizar(clubSeg.replace(/[-_]/g, ' '));
            console.log(`‚úÖ Time extra√≠do: ${result}`);
            
            return result;
        }

        function processarTime(nomeTime, dados) {
            console.log(`\nüìä PROCESSANDO: ${nomeTime} (${dados.length} jogos)`);

            const nomeTimeCanon = normalizarNomeTimeEntrada(nomeTime);
            console.log(`‚úÖ Nome normalizado: ${nomeTimeCanon}`);

            // Verifica se o time j√° foi processado
            if (timesProcessados.find(t => t.time === nomeTimeCanon)) {
                console.log(`‚ö†Ô∏è Time ${nomeTimeCanon} j√° foi processado. Ignorando.`);
                return;
            }

            const stats = initTimeStats(nomeTimeCanon);
            const jogosProcessados = [];

            // Ordena por data para garantir ordem cronol√≥gica
            const dadosOrdenados = dados
                .map(normalizarLinha)
                .filter(jogo => jogo.Data && jogo.Time_Casa && jogo.Time_Visitante)
                .sort((a, b) => {
                    const da = parseDateStr(a.Data);
                    const db = parseDateStr(b.Data);
                    if (!da || !db) return 0;
                    return da.getTime() - db.getTime();
                });

            console.log(`üìã Jogos ordenados: ${dadosOrdenados.length}`);

            // Se o nome do time for gen√©rico, processa TODOS os times do arquivo
            if (nomeTime === 'Time Selecionado') {
                const statsMap = new Map();
                const seen = new Set();

                const linhas = dados
                    .filter(j => j.Data && j.Time_Casa && j.Time_Visitante)
                    .sort((a, b) => new Date(a.Data) - new Date(b.Data));

                for (const jogo of linhas) {
                    const timeCasa = jogo.Time_Casa.trim();
                    const timeVisitante = jogo.Time_Visitante.trim();
                    const gc = parseInt(jogo.Gols_Casa) || 0;
                    const gv = parseInt(jogo.Gols_Visitante) || 0;

                    // Cria registro se o time ainda n√£o estiver no mapa
                    if (!statsMap.has(timeCasa)) statsMap.set(timeCasa, initTimeStats(timeCasa));
                    if (!statsMap.has(timeVisitante)) statsMap.set(timeVisitante, initTimeStats(timeVisitante));

                    // Identificadores √∫nicos de jogo
                    const chaveCasa = `${timeCasa}_${timeVisitante}_${gc}_${gv}_casa`;
                    const chaveFora = `${timeCasa}_${timeVisitante}_${gc}_${gv}_fora`;

                    if (!seen.has(chaveCasa)) {
                        processarJogo(statsMap.get(timeCasa), gc, gv, gc + gv, true, jogo);
                        seen.add(chaveCasa);
                    }
                    if (!seen.has(chaveFora)) {
                        processarJogo(statsMap.get(timeVisitante), gv, gc, gc + gv, false, jogo);
                        seen.add(chaveFora);
                    }
                }

                for (const s of statsMap.values()) calcularPercentuais(s);
                timesProcessados.push(...statsMap.values());
                renderizarTabelas();
                return;
            } else {
                console.log(`üîç DEBUG: Processando time espec√≠fico: ${nomeTime}`);
                // Processa cada jogo - APENAS PARA O TIME ESPEC√çFICO
                dadosOrdenados.forEach(jogo => {
                    const timeCasa = jogo.Time_Casa.trim();
                    const timeVisitante = jogo.Time_Visitante.trim();
                    const golsCasa = parseInt(jogo.Gols_Casa) || 0;
                    const golsVisitante = parseInt(jogo.Gols_Visitante) || 0;

                    // Verifica se o time que estamos processando est√° neste jogo
                    const isTimeCasa = compararNomes(timeCasa, nomeTimeCanon);
                    const isTimeVisitante = compararNomes(timeVisitante, nomeTimeCanon);
                    
                    // DEBUG ESPEC√çFICO PARA GR√äMIO NOVO HORIZONTINO
                    if (nomeTimeCanon.toLowerCase().includes('novo') || nomeTimeCanon.toLowerCase().includes('horizontino')) {
                        console.log(`üîç DEBUG GR√äMIO NOVO HORIZONTINO - Jogo: ${timeCasa} vs ${timeVisitante}`);
                        console.log(`üîç DEBUG: isTimeCasa(${timeCasa}, ${nomeTimeCanon}) = ${isTimeCasa}`);
                        console.log(`üîç DEBUG: isTimeVisitante(${timeVisitante}, ${nomeTimeCanon}) = ${isTimeVisitante}`);
                    }
                    
                    console.log(`üîç DEBUG: Jogo: ${timeCasa} vs ${timeVisitante}`);
                    console.log(`üîç DEBUG: isTimeCasa(${timeCasa}, ${nomeTimeCanon}) = ${isTimeCasa}`);
                    console.log(`üîç DEBUG: isTimeVisitante(${timeVisitante}, ${nomeTimeCanon}) = ${isTimeVisitante}`);

                    if (!isTimeCasa && !isTimeVisitante) {
                        console.log(`üîç DEBUG: Jogo ignorado - time ${nomeTimeCanon} n√£o est√° neste jogo`);
                        return; // Este jogo n√£o envolve o time sendo processado
                    }

                    // Determina os gols do time e do advers√°rio
                    const golsPro = isTimeCasa ? golsCasa : golsVisitante;
                    const golsContra = isTimeCasa ? golsVisitante : golsCasa;
                    const totalGols = golsCasa + golsVisitante;
                    const isCasa = isTimeCasa;

                    // Processa o jogo - APENAS PARA O TIME ESPEC√çFICO
                    processarJogo(stats, golsPro, golsContra, totalGols, isCasa, jogo);
                    jogosProcessados.push({
                        data: jogo.Data,
                        adversario: isTimeCasa ? timeVisitante : timeCasa,
                        placar: `${golsPro}-${golsContra}`,
                        local: isCasa ? 'Casa' : 'Fora'
                    });
                });
            }

            console.log(`‚úÖ APENAS ${nomeTimeCanon} processado: ${stats.jogos} jogos, ${stats.pontos} pontos`);
            console.log(`üéØ N√ÉO acumulando dados de outros times`);

            // Calcula percentuais
            calcularPercentuais(stats);

            // Adiciona √†s listas de times processados
            timesProcessados.push(stats);
            
            console.log('üîç DEBUG: timesProcessados ap√≥s adicionar =', timesProcessados);
            console.log('üîç DEBUG: stats =', stats);
            
            // Renderiza as tabelas com apenas este time
            renderizarTabelas();
        }

        function compararNomes(a, b) {
            if (!a || !b) return false;
            
            // Canoniza os dois lados ANTES de comparar
            const A = normalizarNomeTimeEntrada(a);
            const B = normalizarNomeTimeEntrada(b);
            
            // Normaliza√ß√£o final (deve ser a mesma que `normalizarTime` usa internamente)
            const na = removerAcentos(A.toLowerCase().trim());
            const nb = removerAcentos(B.toLowerCase().trim());
            
            const result = na === nb;
            
            // DEBUG ESPEC√çFICO PARA GR√äMIO NOVO HORIZONTINO
            if (a.toLowerCase().includes('gre') || b.toLowerCase().includes('novo') || b.toLowerCase().includes('horizontino')) {
                console.log(`üîç DEBUG GR√äMIO NOVO HORIZONTINO - compararNomes:`);
                console.log(`  - a: "${a}"`);
                console.log(`  - b: "${b}"`);
                console.log(`  - A: "${A}"`);
                console.log(`  - B: "${B}"`);
                console.log(`  - na: "${na}"`);
                console.log(`  - nb: "${nb}"`);
                console.log(`  - result: ${result}`);
            }
            
            console.log(`üîç DEBUG: compararNomes("${a}", "${b}") = "${A}" vs "${B}" = "${na}" === "${nb}" = ${result}`);
            return result;
        }

        function clearAllData() {
            console.log('üóëÔ∏è DEBUG: Limpando todos os dados...');
            
            // Limpa os inputs de arquivo
            document.getElementById('csvFile').value = '';
            document.getElementById('dirPicker').value = '';
            
            // Limpa o nome do arquivo
            document.getElementById('fileName').textContent = '';
            
            // Limpa o status
            document.getElementById('status').textContent = '';
            document.getElementById('status').className = 'status';
            
            // Limpa as tabelas
            document.getElementById('tradicional').innerHTML = '<div class="loading">Aguardando upload do arquivo CSV...</div>';
            document.getElementById('apostas').innerHTML = '<div class="loading">Aguardando upload do arquivo CSV...</div>';
            
            // Esconde as abas
            document.getElementById('tabsSection').style.display = 'none';
            
            // RESET COMPLETO DAS VARI√ÅVEIS GLOBAIS
            dadosProcessados = [];
            knownClubs = new Set();
            pontosAcumuladosCSV = {};
            timesProcessados = [];
            currentSort = { column: 'pontos', direction: 'desc' };
            
            // Limpa vari√°veis globais se existirem
            if (typeof window.allGamesData !== 'undefined') {
                window.allGamesData = [];
            }
            if (typeof window.processedTeams !== 'undefined') {
                window.processedTeams = [];
            }
            
            console.log('‚úÖ DEBUG: Dados limpos com sucesso!');
            console.log('‚úÖ DEBUG: Sistema resetado completamente!');
            showStatus('Dados limpos com sucesso! Sistema pronto para novos dados.', 'success');
        }

        // Fun√ß√£o para exportar dados em CSV
        function exportarCSV() {
            if (dadosProcessados.length === 0) {
                showStatus('‚ö†Ô∏è Nenhum dado para exportar. Carregue os dados primeiro.', 'error');
                return;
            }

            // Detectar qual aba est√° ativa
            const abaAtiva = document.querySelector('.tab-content.active').id;
            console.log(`üîç DEBUG: Aba ativa detectada: ${abaAtiva}`);

            let headers, csvContent, nomeArquivo;

            if (abaAtiva === 'tradicional') {
                // Exportar dados da tabela tradicional
                headers = [
                    'Posi√ß√£o', 'Time', 'Pontos', 'Jogos', 'Vit√≥rias', 'Empates', 'Derrotas',
                    'Gols Pr√≥', 'Gols Contra', 'Saldo Gols', 'Aproveitamento %', '√öltimos 5 Jogos'
                ];

                csvContent = [
                    headers.join(','),
                    ...dadosProcessados.map(team => [
                        team.pos,
                        `"${team.time}"`,
                        team.pontos,
                        team.jogos,
                        team.vitorias,
                        team.empates,
                        team.derrotas,
                        team.golsPro,
                        team.golsContra,
                        team.saldoGols,
                        team.aproveitamento,
                        `"${team.ultimos5Str}"`
                    ].join(','))
                ].join('\n');

                const dataAtual = new Date().toISOString().split('T')[0];
                nomeArquivo = `tabela_tradicional_${dataAtual}.csv`;

            } else if (abaAtiva === 'apostas') {
                // Exportar dados das estat√≠sticas para apostas
                headers = [
                    'Posi√ß√£o', 'Time', 'Jogos', 'Gols Pr√≥', 'Gols Contra', 'M√©dia Gols Pr√≥', 'M√©dia Gols Contra',
                    'Over 1.5 %', 'Over 2.5 %', 'Over 3.5 %', 'Under 2.5 %', 'BTTS Sim %', 'BTTS N√£o %',
                    'Jogos Casa', 'Vit√≥rias Casa', 'Empates Casa', 'Derrotas Casa', 'Gols Pr√≥ Casa', 'Gols Contra Casa', 'Aproveitamento Casa %',
                    'Jogos Fora', 'Vit√≥rias Fora', 'Empates Fora', 'Derrotas Fora', 'Gols Pr√≥ Fora', 'Gols Contra Fora', 'Aproveitamento Fora %',
                    'Clean Sheets %', '√öltimos 5 Jogos', 'Pontos √öltimos 5'
                ];

                csvContent = [
                    headers.join(','),
                    ...dadosProcessados.map(team => [
                        team.pos,
                        `"${team.time}"`,
                        team.jogos,
                        team.golsPro,
                        team.golsContra,
                        team.mediaGolsPro,
                        team.mediaGolsContra,
                        team.over15Perc,
                        team.over25Perc,
                        team.over35Perc,
                        team.under25Perc,
                        team.bttsYesPerc,
                        team.bttsNoPerc,
                        team.jogosCasa,
                        team.vitoriasCasa,
                        team.empatesCasa,
                        team.derrotasCasa,
                        team.golsProCasa,
                        team.golsContraCasa,
                        team.aprovCasa,
                        team.jogosFora,
                        team.vitoriasFora,
                        team.empatesFora,
                        team.derrotasFora,
                        team.golsProFora,
                        team.golsContraFora,
                        team.aprovFora,
                        team.cleanSheetsPerc,
                        `"${team.ultimos5Str}"`,
                        team.pontosUlt5
                    ].join(','))
                ].join('\n');

                const dataAtual = new Date().toISOString().split('T')[0];
                nomeArquivo = `estatisticas_apostas_${dataAtual}.csv`;
            }

            // Criar e baixar arquivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', nomeArquivo);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`‚úÖ Arquivo ${nomeArquivo} exportado com sucesso!`, 'success');
            console.log(`üìä CSV exportado: ${dadosProcessados.length} times - Aba: ${abaAtiva}`);
        }

        // Fun√ß√£o para ordenar dados
        function sortData(column) {
            console.log(`üîç DEBUG: Ordenando por: ${column}`);
            
            // Se clicou na mesma coluna, inverte a dire√ß√£o
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc'; // Padr√£o: maior primeiro
            }
            
            // Ordena os dados
            dadosProcessados.sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'pos':
                        valueA = a.pos;
                        valueB = b.pos;
                        break;
                    case 'time':
                        valueA = a.time.toLowerCase();
                        valueB = b.time.toLowerCase();
                        break;
                    case 'pontos':
                        valueA = a.pontos;
                        valueB = b.pontos;
                        break;
                    case 'jogos':
                        valueA = a.jogos;
                        valueB = b.jogos;
                        break;
                    case 'vitorias':
                        valueA = a.vitorias;
                        valueB = b.vitorias;
                        break;
                    case 'empates':
                        valueA = a.empates;
                        valueB = b.empates;
                        break;
                    case 'derrotas':
                        valueA = a.derrotas;
                        valueB = b.derrotas;
                        break;
                    case 'golsPro':
                        valueA = a.golsPro;
                        valueB = b.golsPro;
                        break;
                    case 'golsContra':
                        valueA = a.golsContra;
                        valueB = b.golsContra;
                        break;
                    case 'saldoGols':
                        valueA = a.saldoGols;
                        valueB = b.saldoGols;
                        break;
                    case 'aproveitamento':
                        valueA = a.aproveitamento;
                        valueB = b.aproveitamento;
                        break;
                    default:
                        return 0;
                }
                
                if (currentSort.direction === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });
            
            // Atualiza as posi√ß√µes
            dadosProcessados.forEach((team, index) => {
                team.pos = index + 1;
            });
            
            // Re-renderiza as tabelas
            renderTradicional();
            renderApostas();
            
            console.log(`‚úÖ DEBUG: Ordena√ß√£o aplicada: ${column} ${currentSort.direction}`);
        }
    </script>
</body>
</html>